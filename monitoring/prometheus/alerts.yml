groups:
  - name: goaldiggers_alerts
    interval: 30s
    rules:
      - alert: HighAPIErrorRate
        expr: rate(goaldiggers_api_errors_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High API error rate detected"
          description: "API error rate is {{ $value }} errors/sec"
      
      - alert: LowCacheHitRate
        expr: goaldiggers_cache_hit_rate{tier="L1"} < 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "L1 cache hit rate below 50%"
          description: "Consider increasing L1 cache size or investigating cache invalidation"
      
      - alert: SlowAPIResponses
        expr: histogram_quantile(0.95, rate(goaldiggers_api_request_duration_seconds_bucket[5m])) > 1.0
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "API P95 latency above 1 second"
          description: "P95 latency is {{ $value }}s - investigate slow endpoints"
      
      - alert: StaleData
        expr: goaldiggers_data_freshness_seconds{data_type="fixtures"} > 1800
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Fixture data is stale (>30min old)"
          description: "Data age is {{ $value }}s - check data ingestion pipeline"
      
      - alert: PredictionErrors
        expr: rate(goaldiggers_prediction_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High prediction error rate"
          description: "Prediction errors at {{ $value }}/s - check model health"

  # ============================================================================
  # DATA QUALITY ALERTS (NEW)
  # ============================================================================
  
  - name: data_quality
    interval: 30s
    rules:
      # Critical: Data quality below acceptable threshold
      - alert: LowDataQuality
        expr: goaldiggers_validation_quality_score{component="prediction_engine"} < 0.5
        for: 5m
        labels:
          severity: warning
          component: prediction_engine
          team: ml-ops
        annotations:
          summary: "Low data quality detected in {{ $labels.component }}"
          description: "Quality score {{ $value | humanizePercentage }} is below 50% threshold"
          runbook_url: "https://github.com/goaldiggers/platform/blob/main/ALERT_RESPONSE_RUNBOOK.md#-lowdataquality"
          dashboard_url: "http://grafana.goaldiggers.com/d/data-quality"
      
      # Critical: Very low data quality
      - alert: CriticalDataQuality
        expr: goaldiggers_validation_quality_score{component="prediction_engine"} < 0.3
        for: 2m
        labels:
          severity: critical
          component: prediction_engine
          team: ml-ops
        annotations:
          summary: "CRITICAL: Data quality severely degraded"
          description: "Quality score {{ $value | humanizePercentage }} is critically low"
          runbook_url: "https://github.com/goaldiggers/platform/blob/main/ALERT_RESPONSE_RUNBOOK.md#-criticaldataquality"
          dashboard_url: "http://grafana.goaldiggers.com/d/data-quality"
      
      # Warning: High validation failure rate
      - alert: HighValidationFailureRate
        expr: |
          (
            rate(goaldiggers_validation_failed_total{component="prediction_engine"}[5m]) /
            rate(goaldiggers_validation_checks_total{component="prediction_engine"}[5m])
          ) > 0.3
        for: 5m
        labels:
          severity: warning
          component: prediction_engine
          team: data-eng
        annotations:
          summary: "High validation failure rate"
          description: "{{ $value | humanizePercentage }} of validations failing (threshold: 30%)"
          runbook_url: "https://github.com/goaldiggers/platform/blob/main/ALERT_RESPONSE_RUNBOOK.md#%EF%B8%8F-highvalidationfailurerate"
          dashboard_url: "http://grafana.goaldiggers.com/d/data-quality"
      
      # Critical: Predictions being blocked
      - alert: PredictionsBlocked
        expr: increase(goaldiggers_validation_blocked_total{component="prediction_engine"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: prediction_engine
          team: ml-ops
        annotations:
          summary: "Predictions blocked due to data quality"
          description: "{{ $value }} predictions blocked. Issue: {{ $labels.blocking_issue }}"
          runbook_url: "https://github.com/goaldiggers/platform/blob/main/ALERT_RESPONSE_RUNBOOK.md#-predictionsblocked"
          dashboard_url: "http://grafana.goaldiggers.com/d/data-quality"
      
      # Warning: Low feature coverage
      - alert: LowFeatureCoverage
        expr: goaldiggers_validation_feature_coverage{feature_type=~"form|standings"} < 0.5
        for: 10m
        labels:
          severity: warning
          component: data_pipeline
          team: data-eng
        annotations:
          summary: "Low coverage for {{ $labels.feature_type }}"
          description: "Coverage is {{ $value | humanizePercentage }} (threshold: 50%)"
          runbook_url: "https://github.com/goaldiggers/platform/blob/main/ALERT_RESPONSE_RUNBOOK.md#%EF%B8%8F-lowfeaturecoverage"
          dashboard_url: "http://grafana.goaldiggers.com/d/data-quality"

  - name: data_quality_trends
    interval: 1m
    rules:
      # Recording rule: Average quality score over 5 minutes
      - record: data_quality:avg_quality_score:5m
        expr: avg_over_time(goaldiggers_validation_quality_score{component="prediction_engine"}[5m])
      
      # Recording rule: Validation pass rate
      - record: data_quality:pass_rate:5m
        expr: |
          rate(goaldiggers_validation_passed_total{component="prediction_engine"}[5m]) /
          rate(goaldiggers_validation_checks_total{component="prediction_engine"}[5m])

